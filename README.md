#binary websocketをはじめよう

みなさん、websocketで何かしらの構造化されたデータを送るとき、どうやってシリアライズしているでしょうか。
おそらく `JSON.stringify` あたりを使ってJSON文字列にしていますよね。実際、これは一番手軽な方法です。
しかし、通信量やCPUの処理コスト(特にサーバ側)などを考えるとJSONというものは結構無駄があります。

より通信量やCPUコストを抑える一つの方法として、バイナリでデータをやりとりする方法があります。
これはネイティブなアプリやサーバサイドでは昔から行われていたことです。
JavaScriptでも文字列をバイナリに見立てて処理するという方法もありましたが、現実的ではありませんでした。
しかし、最近ではHTML5関連のAPIでTypedArrayというものが登場して、
バイナリ操作も以前より格段に楽に行えるようになっています。
もちろんwebsocketでもバイナリ形式でのやりとりをサポートしています。
現状では、バイナリでの通信は全ての環境で使えるというわけではありませんが、そのうち絶対に使うようになるはずです。

ここではwebsocketでお絵かきアプリ線データのシリアライズ・デシリアライズ部分を

* JSON
* MessagePack
* 独自の構造のバイナリ

のそれぞれで実装してみました。以下の章で見ていきたいと思います。

ここで紹介するデモアプリはgithubより落として試すことができます(Chromeでしか動作確認していません)。

###インストール

```
git clone git://github.com/ukyo/binary-websocket-samples.git
cd binary-websocket-samples
npm install
```

###アプリの起動

`app-json.js`,`app-msgpack.js`,`app-binary.js` の3種類がありますが、
実装の仕方が違うだけでブラウザ上での挙動は同じです。
以下、 `app-json.js` での実行例です。

```
node app-json.js
```

##お絵かきアプリの概要

以下の画像のようにカラーピッカーと線の太さを変えるスライダーのついたお絵かきアプリを実装しました。

![screenshot](https://raw.github.com/ukyo/binary-websocket-samples/master/image/screenshot.png)

線のデータ構造は以下の表のように定義します。

名前 | データ
-----|-------
color| 線の色。rgb値。例:`[255, 255, 255]`
start| 線の開始位置の座標。例:`[100, 200]`
end  | 線の終了位置の座標。
width| 線の幅。

###クライアント側の共通部分

###サーバ側の共通部分

###JSON

###MessagePack

###独自の構造のバイナリ

##まとめ

##おまけ
